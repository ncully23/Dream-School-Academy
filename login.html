<!DOCTYPE html>
<html lang="en" data-page="login">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login — Dream School Academy</title>

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0f1420; --surface:#1b2231; --ink:#e8eefc; --muted:#a9b5cc;
      --brand:#00d8ff; --brand-ink:#001018; --border:rgba(255,255,255,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Outfit,system-ui,sans-serif}
    main{min-height:100dvh;display:grid;place-items:center;padding:24px}
    .card{width:min(520px,92vw);background:var(--surface);border:1px solid var(--border);border-radius:18px;padding:20px;box-shadow:0 12px 30px rgba(0,0,0,.25)}
    h1{margin:.25rem 0 1rem}
    label{display:block;font-size:.95rem;color:var(--muted);margin:.5rem 0 .25rem}
    input{width:100%;padding:.85rem 1rem;border-radius:12px;border:1px solid var(--border);background:#0f1420;color:var(--ink)}
    .row{display:flex;gap:.6rem;flex-wrap:wrap;margin-top:1rem}
    .btn{appearance:none;border:0;border-radius:999px;padding:.8rem 1rem;font-weight:800;letter-spacing:.2px;cursor:pointer}
    .primary{background:var(--brand);color:var(--brand-ink);box-shadow:0 6px 14px rgba(105,229,255,.22)}
    .ghost{background:transparent;color:var(--ink);box-shadow:inset 0 0 0 1px var(--border)}
    .google{display:inline-flex;align-items:center;gap:.6rem;background:#fff;color:#111;border:0;border-radius:999px;padding:.8rem 1rem;cursor:pointer}
    .hr{display:flex;align-items:center;gap:.8rem;margin:1rem 0}
    .hr::before,.hr::after{content:"";height:1px;flex:1;background:var(--border)}
    .muted{color:var(--muted)}
    .status{min-height:1.1rem;margin-top:.6rem}
    .tabs{display:flex;gap:.4rem;background:#121826;padding:.4rem;border-radius:12px;margin:.75rem 0 0}
    .tabs button{flex:1;padding:.7rem 1rem;border:0;border-radius:10px;background:transparent;color:var(--ink);font-weight:700;cursor:pointer}
    .tabs button.active{background:var(--brand);color:var(--brand-ink)}
  </style>
</head>
<body>
  <!-- optional shared header (shell.js will fill this if you include it) -->
  <div id="site-header"></div>

  <main>
    <div class="card">
      <h1>Welcome back</h1>
      <p class="muted">Sign in to save progress and track scores.</p>

      <div class="tabs" role="tablist">
        <button id="tab-login" class="active" aria-selected="true">Log In</button>
        <button id="tab-signup" aria-selected="false">Sign Up</button>
      </div>

      <!-- Login -->
      <form id="login-form" autocomplete="on">
        <label for="login-email">Email</label>
        <input id="login-email" type="email" placeholder="you@example.com" required />
        <label for="login-password">Password</label>
        <input id="login-password" type="password" placeholder="••••••••" required />

        <div class="row">
          <button id="login-submit" class="btn primary" type="submit">Log In</button>
          <button id="reset" class="btn ghost" type="button">Forgot password?</button>
        </div>

        <div class="hr"><span class="muted">or</span></div>
        <button id="google-login" class="google" type="button">
          <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="" width="18" height="18">
          Continue with Google
        </button>
        <div id="login-status" class="status"></div>
      </form>

      <!-- Signup -->
      <form id="signup-form" autocomplete="on" style="display:none">
        <label for="signup-first">First name (optional)</label>
        <input id="signup-first" type="text" placeholder="e.g., Alex" />
        <label for="signup-email">Email</label>
        <input id="signup-email" type="email" placeholder="you@example.com" required />
        <label for="signup-password">Password</label>
        <input id="signup-password" type="password" placeholder="Minimum 6 characters" minlength="6" required />

        <div class="row">
          <button id="signup-submit" class="btn primary" type="submit">Create account</button>
        </div>

        <div class="hr"><span class="muted">or</span></div>
        <button id="google-signup" class="google" type="button">
          <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="" width="18" height="18">
          Continue with Google
        </button>
        <div id="signup-status" class="status"></div>
      </form>
    </div>
  </main>

  <div id="site-footer"></div>

  <!-- shared shell (header/nav); optional but recommended -->
  <script type="module" src="/assets/shell.js"></script>

  <!-- LOGIN LOGIC -->
  <script type="module">
    // Reuse shared Firebase instances
    import { auth, db, googleProvider } from "/assets/firebase-init.js";

    // Extra auth + firestore functions
    import {
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      sendPasswordResetEmail,
      updateProfile,
      signInWithPopup,
      signInWithRedirect,
      getRedirectResult
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

    import {
      doc,
      getDoc,
      setDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const nice = (e) => ({
      "auth/invalid-email":        "That email looks invalid.",
      "auth/missing-password":     "Enter your password.",
      "auth/weak-password":        "Use 6+ characters for your password.",
      "auth/email-already-in-use": "That email is already registered.",
      "auth/user-not-found":       "No account with that email.",
      "auth/wrong-password":       "Incorrect password.",
      "auth/popup-blocked":        "Popup blocked. Check your browser settings.",
      "auth/unauthorized-domain":  "Add this domain in Firebase → Auth → Authorized domains."
    }[e?.code] || e?.message || "Something went wrong.");

    async function ensureProfile(u, first = "") {
      if (!u) return;
      const ref  = doc(db, "users", u.uid);
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        await setDoc(ref, {
          userId: u.uid,
          email: u.email || "",
          name: (u.displayName || first || "").trim(),
          createdAt: serverTimestamp()
        });
      }
    }

    // Grab DOM elements
    const tabLogin    = document.getElementById("tab-login");
    const tabSignup   = document.getElementById("tab-signup");
    const loginForm   = document.getElementById("login-form");
    const signupForm  = document.getElementById("signup-form");
    const loginStatus = document.getElementById("login-status");
    const signupStatus= document.getElementById("signup-status");
    const btnLogin    = document.getElementById("login-submit");
    const btnSignup   = document.getElementById("signup-submit");
    const btnReset    = document.getElementById("reset");
    const btnGoogleIn = document.getElementById("google-login");
    const btnGoogleUp = document.getElementById("google-signup");

    if (!tabLogin || !tabSignup || !loginForm || !signupForm) {
      console.warn("Login tabs or forms not found on this page");
    } else {
      // ----- Tabs -----
      const showLogin = () => {
        tabLogin.classList.add("active");
        tabLogin.setAttribute("aria-selected", "true");
        tabSignup.classList.remove("active");
        tabSignup.setAttribute("aria-selected", "false");
        loginForm.style.display = "block";
        signupForm.style.display = "none";
      };

      const showSignup = () => {
        tabSignup.classList.add("active");
        tabSignup.setAttribute("aria-selected", "true");
        tabLogin.classList.remove("active");
        tabLogin.setAttribute("aria-selected", "false");
        signupForm.style.display = "block";
        loginForm.style.display = "none";
      };

      tabLogin.addEventListener("click", showLogin);
      tabSignup.addEventListener("click", showSignup);
      showLogin(); // default

      // ----- Login -----
      if (btnLogin && loginStatus) {
        btnLogin.addEventListener("click", async (e) => {
          e.preventDefault();
          loginStatus.textContent = "Signing in…";
          try {
            const email = document.getElementById("login-email").value.trim();
            const pass  = document.getElementById("login-password").value;
            const cred  = await signInWithEmailAndPassword(auth, email, pass);
            await ensureProfile(cred.user);
            location.href = "/";
          } catch (err) {
            console.error(err);
            loginStatus.textContent = nice(err);
          }
        });
      }

      if (btnReset && loginStatus) {
        btnReset.addEventListener("click", async () => {
          const email = document.getElementById("login-email").value.trim();
          if (!email) {
            loginStatus.textContent = "Enter your email first.";
            return;
          }
          try {
            await sendPasswordResetEmail(auth, email);
            loginStatus.textContent = "Password reset email sent.";
          } catch (err) {
            console.error(err);
            loginStatus.textContent = nice(err);
          }
        });
      }

      // Google login
      if (btnGoogleIn && loginStatus) {
        btnGoogleIn.addEventListener("click", async () => {
          loginStatus.textContent = "Opening Google…";
          try {
            const res = await signInWithPopup(auth, googleProvider);
            await ensureProfile(res.user);
            location.href = "/";
          } catch (err) {
            console.error(err);
            if (["auth/popup-blocked","auth/popup-closed-by-user","auth/unauthorized-domain"].includes(err.code)) {
              loginStatus.textContent = nice(err);
              try {
                await signInWithRedirect(auth, googleProvider);
              } catch (e) {
                console.error(e);
                loginStatus.textContent = nice(e);
              }
            } else {
              loginStatus.textContent = nice(err);
            }
          }
        });
      }

      // ----- Signup -----
      if (btnSignup && signupStatus) {
        btnSignup.addEventListener("click", async (e) => {
          e.preventDefault();
          signupStatus.textContent = "Creating account…";
          try {
            const first = document.getElementById("signup-first").value.trim();
            const email = document.getElementById("signup-email").value.trim();
            const pass  = document.getElementById("signup-password").value;
            const cred  = await createUserWithEmailAndPassword(auth, email, pass);
            if (first) {
              try { await updateProfile(cred.user, { displayName: first }); } catch {}
            }
            await ensureProfile(cred.user, first);
            location.href = "/";
          } catch (err) {
            console.error(err);
            signupStatus.textContent = nice(err);
          }
        });
      }

      if (btnGoogleUp && signupStatus) {
        btnGoogleUp.addEventListener("click", async () => {
          signupStatus.textContent = "Opening Google…";
          try {
            const res = await signInWithPopup(auth, googleProvider);
            await ensureProfile(res.user);
            location.href = "/";
          } catch (err) {
            console.error(err);
            if (["auth/popup-blocked","auth/popup-closed-by-user","auth/unauthorized-domain"].includes(err.code)) {
              signupStatus.textContent = nice(err);
              try {
                await signInWithRedirect(auth, googleProvider);
              } catch (e) {
                console.error(e);
                signupStatus.textContent = nice(e);
              }
            } else {
              signupStatus.textContent = nice(err);
            }
          }
        });
      }
    }

    // Handle Google redirect (popup blocked)
    try {
      const r = await getRedirectResult(auth);
      if (r?.user) {
        await ensureProfile(r.user);
        location.href = "/";
      }
    } catch (e) {
      console.warn("Redirect sign-in failed:", e);
    }

    onAuthStateChanged(auth, (user) => {
      // Optional auto-redirect if already logged in
      // if (user) location.href = "/";
    });
  </script>

  <noscript><p style="text-align:center;color:#ffb4b4">JavaScript is required to sign in.</p></noscript>
</body>
</html>
