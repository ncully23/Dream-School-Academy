<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login / Signup</title>

  <!-- Load global site styles BEFORE header appears -->
  <link rel="stylesheet" href="/assets/site.css">
  <link rel="stylesheet" href="/assets/login.css">
</head>

<body>

  <!-- Header placeholder (shell.js will load header.html into this) -->
  <div id="site-header"></div>

  <main>
    <div class="card">

      <!-- ---- LOGIN / SIGNUP TABS ---- -->
      <div class="tabs">
        <button id="tab-login"  class="tab active" aria-selected="true">Login</button>
        <button id="tab-signup" class="tab" aria-selected="false">Sign Up</button>
      </div>

      <!-- ---- LOGIN FORM ---- -->
      <form id="login-form" class="form-block">
        <h2>Welcome back</h2>

        <div class="field">
          <label>Email</label>
          <input id="login-email" type="email" required />
        </div>

        <div class="field">
          <label>Password</label>
          <input id="login-password" type="password" required />
        </div>

        <button id="login-submit" class="btn-primary">Log In</button>

        <p id="login-status" class="status"></p>

        <p class="alt-action">
          <a id="reset" href="javascript:void(0)">Forgot password?</a>
        </p>

        <button id="google-login" class="btn-google" type="button">Sign in with Google</button>
      </form>

      <!-- ---- SIGNUP FORM ---- -->
      <form id="signup-form" class="form-block" style="display:none;">
        <h2>Create your account</h2>

        <div class="field">
          <label>First name</label>
          <input id="signup-first" type="text" />
        </div>

        <div class="field">
          <label>Email</label>
          <input id="signup-email" type="email" required />
        </div>

        <div class="field">
          <label>Password</label>
          <input id="signup-password" type="password" required />
        </div>

        <button id="signup-submit" class="btn-primary">Sign Up</button>

        <p id="signup-status" class="status"></p>

        <button id="google-signup" class="btn-google" type="button">Sign up with Google</button>
      </form>

    </div>
  </main>


  <!-- Load header + login logic -->
  <script type="module" src="/assets/shell.js"></script>

  <!-- LOGIN / SIGNUP LOGIC -->
  <script type="module">

    import { auth, db, googleProvider } from "/assets/firebase-init.js";

    import {
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      sendPasswordResetEmail,
      updateProfile,
      signInWithPopup,
      signInWithRedirect,
      getRedirectResult
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

    import {
      doc,
      getDoc,
      setDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // Friendly error messages
    const nice = (e) => ({
      "auth/invalid-email":        "That email looks invalid.",
      "auth/missing-password":     "Enter your password.",
      "auth/weak-password":        "Use 6+ characters for your password.",
      "auth/email-already-in-use": "That email is already registered.",
      "auth/user-not-found":       "No account with that email.",
      "auth/wrong-password":       "Incorrect password.",
      "auth/popup-blocked":        "Popup blocked.",
      "auth/unauthorized-domain":  "Unauthorized domain in Firebase."
    }[e?.code] || e?.message || "Something went wrong.");

    async function ensureProfile(u, first = "") {
      if (!u) return;
      const ref  = doc(db, "users", u.uid);
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        await setDoc(ref, {
          userId: u.uid,
          email: u.email || "",
          name: (u.displayName || first || "").trim(),
          createdAt: serverTimestamp()
        });
      }
    }

    // ----- Grab DOM elements -----
    const tabLogin    = document.getElementById("tab-login");
    const tabSignup   = document.getElementById("tab-signup");
    const loginForm   = document.getElementById("login-form");
    const signupForm  = document.getElementById("signup-form");
    const loginStatus = document.getElementById("login-status");
    const signupStatus= document.getElementById("signup-status");
    const btnLogin    = document.getElementById("login-submit");
    const btnSignup   = document.getElementById("signup-submit");
    const btnReset    = document.getElementById("reset");
    const btnGoogleIn = document.getElementById("google-login");
    const btnGoogleUp = document.getElementById("google-signup");

    // Prevent crashes if something missing
    if (!tabLogin || !tabSignup || !loginForm || !signupForm) {
      console.warn("Login UI missing — skipping login script.");
    } else {

      // ----- Tabs -----
      const showLogin = () => {
        tabLogin.classList.add("active");
        tabSignup.classList.remove("active");
        loginForm.style.display = "block";
        signupForm.style.display = "none";
      };

      const showSignup = () => {
        tabSignup.classList.add("active");
        tabLogin.classList.remove("active");
        signupForm.style.display = "block";
        loginForm.style.display = "none";
      };

      tabLogin.addEventListener("click", showLogin);
      tabSignup.addEventListener("click", showSignup);

      showLogin();  // default

      // ----- Login -----
      if (btnLogin) {
        btnLogin.addEventListener("click", async (e) => {
          e.preventDefault();
          loginStatus.textContent = "Signing in…";
          try {
            const email = document.getElementById("login-email").value.trim();
            const pass  = document.getElementById("login-password").value;
            const cred  = await signInWithEmailAndPassword(auth, email, pass);
            await ensureProfile(cred.user);
            location.href = "/";
          } catch (err) {
            loginStatus.textContent = nice(err);
          }
        });
      }

      // Reset password
      if (btnReset) {
        btnReset.addEventListener("click", async () => {
          const email = document.getElementById("login-email").value.trim();
          if (!email) return loginStatus.textContent = "Enter your email.";
          try {
            await sendPasswordResetEmail(auth, email);
            loginStatus.textContent = "Reset email sent.";
          } catch (err) {
            loginStatus.textContent = nice(err);
          }
        });
      }

      // Google login
      if (btnGoogleIn) {
        btnGoogleIn.addEventListener("click", async () => {
          loginStatus.textContent = "Opening Google…";
          try {
            const res = await signInWithPopup(auth, googleProvider);
            await ensureProfile(res.user);
            location.href = "/";
          } catch (err) {
            loginStatus.textContent = nice(err);
          }
        });
      }

      // ----- Signup -----
      if (btnSignup) {
        btnSignup.addEventListener("click", async (e) => {
          e.preventDefault();
          signupStatus.textContent = "Creating account…";
          try {
            const first = document.getElementById("signup-first").value.trim();
            const email = document.getElementById("signup-email").value.trim();
            const pass  = document.getElementById("signup-password").value;
            const cred  = await createUserWithEmailAndPassword(auth, email, pass);

            if (first) {
              try { await updateProfile(cred.user, { displayName: first }); } catch {}
            }

            await ensureProfile(cred.user, first);
            location.href = "/";
          } catch (err) {
            signupStatus.textContent = nice(err);
          }
        });
      }

      // Google signup
      if (btnGoogleUp) {
        btnGoogleUp.addEventListener("click", async () => {
          signupStatus.textContent = "Opening Google…";
          try {
            const res = await signInWithPopup(auth, googleProvider);
            await ensureProfile(res.user);
            location.href = "/";
          } catch (err) {
            signupStatus.textContent = nice(err);
          }
        });
      }
    }

    // Handle redirect fallback
    try {
      const r = await getRedirectResult(auth);
      if (r?.user) {
        await ensureProfile(r.user);
        location.href = "/";
      }
    } catch (e) {
      console.warn("Redirect failed:", e);
    }

  </script>
</body>
</html>
