<script type="module">
  // Reuse shared Firebase instances
  import { auth, db, googleProvider } from "/assets/firebase-init.js";

  // Pull in the extra auth + firestore functions we need
  import {
    onAuthStateChanged,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    sendPasswordResetEmail,
    updateProfile,
    signInWithPopup,
    signInWithRedirect,
    getRedirectResult,
    setPersistence,
    browserLocalPersistence,
    browserSessionPersistence
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

  import {
    doc,
    getDoc,
    setDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  // --- Redirect target (e.g. ?redirectTo=/practice/circles.html) ---
  const params      = new URLSearchParams(location.search);
  const redirectTo  = params.get("redirectTo") || "/";

  // Friendly error messages
  const nice = (e) => ({
    'auth/invalid-email':        'That email looks invalid.',
    'auth/missing-password':     'Enter your password.',
    'auth/weak-password':        'Use 6+ characters for your password.',
    'auth/email-already-in-use': 'That email is already registered.',
    'auth/user-not-found':       'No account with that email.',
    'auth/wrong-password':       'Incorrect password.',
    'auth/popup-blocked':        'Popup blocked. Check your browser settings.',
    'auth/unauthorized-domain':  'Add this domain in Firebase → Auth → Authorized domains.'
  }[e?.code] || e?.message || 'Something went wrong.');

  // Ensure profile document exists — stored under `users/{uid}`
  async function ensureProfile(u, first = "") {
    if (!u) return;
    const ref  = doc(db, "users", u.uid);
    const snap = await getDoc(ref);
    if (!snap.exists()) {
      await setDoc(ref, {
        userId: u.uid,
        email: u.email || "",
        name: (u.displayName || first || "").trim(),
        createdAt: serverTimestamp()
      });
    }
  }

  // Tabs
  const tabLogin   = document.getElementById('tab-login');
  const tabSignup  = document.getElementById('tab-signup');
  const loginForm  = document.getElementById('login-form');
  const signupForm = document.getElementById('signup-form');

  const showLogin = () => {
    tabLogin.classList.add('active');
    tabLogin.setAttribute('aria-selected','true');
    tabSignup.classList.remove('active');
    tabSignup.setAttribute('aria-selected','false');
    loginForm.style.display = 'block';
    signupForm.style.display = 'none';
  };

  const showSignup = () => {
    tabSignup.classList.add('active');
    tabSignup.setAttribute('aria-selected','true');
    tabLogin.classList.remove('active');
    tabLogin.setAttribute('aria-selected','false');
    signupForm.style.display = 'block';
    loginForm.style.display = 'none';
  };

  tabLogin.addEventListener('click', showLogin);
  tabSignup.addEventListener('click', showSignup);

  // --- Shared helpers ---
  const loginStatus   = document.getElementById('login-status');
  const signupStatus  = document.getElementById('signup-status');
  const rememberCheck = document.getElementById('remember-me');

  async function applyPersistence() {
    const remember = rememberCheck ? rememberCheck.checked : true;
    const mode = remember ? browserLocalPersistence : browserSessionPersistence;
    await setPersistence(auth, mode);
  }

  function goAfterAuth() {
    location.href = redirectTo;
  }

  // --- Email/password Login ---
  document.getElementById('login-submit').addEventListener('click', async (e) => {
    e.preventDefault();
    loginStatus.textContent = 'Signing in…';
    try {
      await applyPersistence();
      const email = document.getElementById('login-email').value.trim();
      const pass  = document.getElementById('login-password').value;
      const cred  = await signInWithEmailAndPassword(auth, email, pass);
      await ensureProfile(cred.user);
      goAfterAuth();
    } catch (err) {
      console.error(err);
      loginStatus.textContent = nice(err);
    }
  });

  // Reset password
  document.getElementById('reset').addEventListener('click', async () => {
    const email = document.getElementById('login-email').value.trim();
    if (!email) {
      loginStatus.textContent = 'Enter your email first.';
      return;
    }
    try {
      await sendPasswordResetEmail(auth, email);
      loginStatus.textContent = 'Password reset email sent. Check your inbox and spam folder.';
    } catch (err) {
      console.error(err);
      loginStatus.textContent = nice(err);
    }
  });

  // --- Google login ---
  document.getElementById('google-login').addEventListener('click', async () => {
    loginStatus.textContent = 'Opening Google…';
    try {
      await applyPersistence();
      const res = await signInWithPopup(auth, googleProvider);
      await ensureProfile(res.user);
      goAfterAuth();
    } catch (err) {
      console.error(err);
      if (['auth/popup-blocked','auth/popup-closed-by-user','auth/unauthorized-domain'].includes(err.code)) {
        loginStatus.textContent = nice(err);
        try {
          await applyPersistence();
          await signInWithRedirect(auth, googleProvider);
        } catch (e) {
          console.error(e);
          loginStatus.textContent = nice(e);
        }
      } else {
        loginStatus.textContent = nice(err);
      }
    }
  });

  // --- Email/password Signup ---
  document.getElementById('signup-submit').addEventListener('click', async (e) => {
    e.preventDefault();
    signupStatus.textContent = 'Creating account…';
    try {
      await applyPersistence();
      const first = document.getElementById('signup-first').value.trim();
      const email = document.getElementById('signup-email').value.trim();
      const pass  = document.getElementById('signup-password').value;
      const cred  = await createUserWithEmailAndPassword(auth, email, pass);
      if (first) {
        try { await updateProfile(cred.user, { displayName: first }); } catch {}
      }
      await ensureProfile(cred.user, first);
      signupStatus.textContent = 'Account created! Redirecting…';
      goAfterAuth();
    } catch (err) {
      console.error(err);
      signupStatus.textContent = nice(err);
    }
  });

  // --- Google Signup ---
  document.getElementById('google-signup').addEventListener('click', async () => {
    signupStatus.textContent = 'Opening Google…';
    try {
      await applyPersistence();
      const res = await signInWithPopup(auth, googleProvider);
      await ensureProfile(res.user);
      goAfterAuth();
    } catch (err) {
      console.error(err);
      if (['auth/popup-blocked','auth/popup-closed-by-user','auth/unauthorized-domain'].includes(err.code)) {
        signupStatus.textContent = nice(err);
        try {
          await applyPersistence();
          await signInWithRedirect(auth, googleProvider);
        } catch (e) {
          console.error(e);
          signupStatus.textContent = nice(e);
        }
      } else {
        signupStatus.textContent = nice(err);
      }
    }
  });

  // Handle Google redirect (if popup blocked)
  try {
    const r = await getRedirectResult(auth);
    if (r?.user) {
      await ensureProfile(r.user);
      goAfterAuth();
    }
  } catch (e) {
    console.warn('Redirect sign-in failed:', e);
  }

  onAuthStateChanged(auth, (user) => {
    // Optional: if already logged in, bounce them to redirect target
    // if (user) goAfterAuth();
  });
</script>
