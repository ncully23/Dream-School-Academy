<script type="module">
/* ===== Firebase imports for history/progress ===== */
import { auth, db } from "/assets/firebase-init.js";
import {
  collection,
  addDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

/* ===================== Exam Data ===================== */
const exam = {
  storageKey: 'dsa-circles-bluebook-v7',
  summaryKey: 'dsa-circles-summary-v1', // where we store for the summary page
  sectionTitle: 'Section 1, Module 1: Math â€” Circles (Practice)',
  timeLimitSec: 30 * 60,
  questions: [
    { id:'q1',
      prompt:'A circle has radius 5 cm. What is its circumference?',
      choices:['10Ï€ cm','25Ï€ cm','5Ï€ cm','50Ï€ cm'],
      answerIndex:0,
      explanation:'Use C = 2Ï€r. With r = 5, C = 2Â·Ï€Â·5 = 10Ï€ cm.' },
    { id:'q2',
      prompt:'If a circleâ€™s area is 49Ï€, what is its radius?',
      choices:['3','7','14','24.5'],
      answerIndex:1,
      explanation:'Area A = Ï€rÂ². If A = 49Ï€, then rÂ² = 49 and r = 7.' },
    { id:'q3',
      prompt:'A circle passes through (0,0) and (0,6) with center at (0,3). What is its equation?',
      choices:['(x âˆ’ 0)Â² + (y âˆ’ 3)Â² = 9','(x âˆ’ 3)Â² + (y âˆ’ 0)Â² = 9','(x âˆ’ 3)Â² + (y âˆ’ 3)Â² = 6','(x âˆ’ 0)Â² + (y âˆ’ 6)Â² = 3'],
      answerIndex:0,
      explanation:'Center (0,3); radius is the distance to (0,0): âˆš[(0âˆ’0)Â²+(0âˆ’3)Â²] = 3. Equation: (xâˆ’0)Â² + (yâˆ’3)Â² = 3Â² = 9.' },
    { id:'q4',
      prompt:'For r = 10 and Î¸ = Ï€/3, what is the arc length s?',
      choices:['10Ï€/3','20Ï€/3','30Ï€','10','Ï€/3'],
      answerIndex:0,
      explanation:'Arc length s = rÎ¸ (Î¸ in radians). So s = 10Â·(Ï€/3) = 10Ï€/3.' },
    { id:'q5',
      prompt:'Sector area for r = 6 and Î¸ = Ï€/2 is',
      choices:['9Ï€','18Ï€','36Ï€','3Ï€'],
      answerIndex:1,
      explanation:'Sector area = (1/2) rÂ² Î¸ = (1/2)Â·36Â·(Ï€/2) = 18Ï€.' },
    { id:'q6',
      prompt:'If the diameter is 18, the area is',
      choices:['81Ï€','36Ï€','18Ï€','9Ï€'],
      answerIndex:0,
      explanation:'Diameter 18 â‡’ r = 9. Area = Ï€rÂ² = Ï€Â·81 = 81Ï€.' }
  ]
};

/* ===================== State ===================== */
const state = {
  index: 0,
  answers: {},        // { qid: choiceIndex }
  flags: {},          // { qid: true }
  elims: {},          // { qid: Set([choiceIndex,...]) }
  eliminateMode: false,
  remaining: exam.timeLimitSec,
  timerId: null,
  timerHidden: false,
  finished: false,
  reviewMode: false
};

/* ===================== DOM ===================== */
const el = {
  sectionTitle: document.getElementById('sectionTitle'),
  timeLeft: document.getElementById('timeLeft'),
  toggleTimer: document.getElementById('toggleTimer'),
  qbadge: document.getElementById('qbadge'),
  qtitle: document.getElementById('qtitle'),
  choices: document.getElementById('choices'),
  flagTop: document.getElementById('flagTop'),
  flagLabel: document.getElementById('flagLabel'),
  elimToggle: document.getElementById('elimToggle'),
  elimHint: document.getElementById('elimHint'),

  back: document.getElementById('btnBack'),
  next: document.getElementById('btnNext'),
  finish: document.getElementById('btnFinish'),

  progress: document.getElementById('progress'),
  pill: document.getElementById('centerPill'),
  pillText: document.getElementById('pillText'),
  pillFlag: document.getElementById('pillFlag'),

  pop: document.getElementById('popover'),
  popGrid: document.getElementById('popGrid'),
  popClose: document.getElementById('popClose'),
  goReview: document.getElementById('goReview'),

  checkPage: document.getElementById('checkPage'),
  checkGrid: document.getElementById('checkGrid'),

  dashrow: document.getElementById('dashrow')
};

/* ===================== Static rows ===================== */
(function buildTicks(){
  for(let i=0;i<54;i++){
    const d=document.createElement('div');
    d.className='dash';
    el.dashrow.appendChild(d);
  }
})();
(function buildProgress(){
  const seg = Math.max(24, exam.questions.length * 2);
  el.progress.style.setProperty('--seg', seg);
  el.progress.innerHTML='';
  for(let i=0;i<seg;i++){
    const s=document.createElement('div');
    s.className='seg';
    el.progress.appendChild(s);
  }
})();

/* ===================== Storage ===================== */
function loadSaved(){
  try{
    const data = JSON.parse(localStorage.getItem(exam.storageKey)||'null');
    if(!data) return;
    Object.assign(state.answers, data.answers||{});
    Object.assign(state.flags, data.flags||{});
    if (data.elims) {
      Object.keys(data.elims).forEach(q=> state.elims[q] = new Set(data.elims[q]));
    }
    if (typeof data.remaining==='number') state.remaining = data.remaining;
    if (typeof data.index==='number') state.index = clamp(data.index, 0, exam.questions.length-1);
  }catch(e){}
}
function save(){
  const elimsObj = {};
  Object.keys(state.elims).forEach(q=>{ elimsObj[q] = Array.from(state.elims[q]||[]); });
  localStorage.setItem(exam.storageKey, JSON.stringify({
    answers: state.answers,
    flags: state.flags,
    elims: elimsObj,
    remaining: state.remaining,
    index: state.index
  }));
}

/* ====== Always reset on page load for this practice ====== */
function resetPractice() {
  try { localStorage.removeItem(exam.storageKey); } catch(e){}
  state.index = 0;
  state.answers = {};
  state.flags = {};
  state.elims = {};
  state.eliminateMode = false;
  state.remaining = exam.timeLimitSec;
  state.finished = false;
  state.reviewMode = false;
}

/* ===================== Timer ===================== */
function startTimer(){
  if(state.timerId || state.finished) return;
  tick();
  state.timerId=setInterval(tick,1000);
}
function tick(){
  if (state.remaining<=0) return finishExam();
  state.remaining--;
  const m=String(Math.floor(state.remaining/60)).padStart(2,'0');
  const s=String(state.remaining%60).padStart(2,'0');
  if(!state.timerHidden) el.timeLeft.textContent=`${m}:${s}`;
  save();
  if(state.remaining<=0) finishExam();
}
el.toggleTimer.addEventListener('click', ()=>{
  state.timerHidden=!state.timerHidden;
  el.toggleTimer.textContent = state.timerHidden ? 'Hide' : 'Hide'; // label optional
  el.timeLeft.style.visibility = state.timerHidden ? 'hidden' : 'visible';
});

/* ===================== Renderers ===================== */
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

function render(){
  el.sectionTitle.textContent = exam.sectionTitle;
  renderQuestion();
  renderProgress();
  buildPopGrid();
  buildCheckGrid();
  updateNavs();
  updateFlagVisuals();
  updatePillFlag();
  const m=String(Math.floor(state.remaining/60)).padStart(2,'0');
  const s=String(state.remaining%60).padStart(2,'0');
  el.timeLeft.textContent=`${m}:${s}`;
}

function renderQuestion(){
  const q = exam.questions[state.index];

  el.qbadge.textContent = state.index + 1;
  el.qtitle.textContent = q.prompt;

  const letter = i => String.fromCharCode(65+i);
  const elimSet = state.elims[q.id] || new Set();
  el.choices.innerHTML = q.choices.map((t,i)=>{
    const id=`${q.id}_c${i}`;
    const checked = state.answers[q.id]===i ? 'checked':'';
    const elimClass = elimSet.has(i) ? 'eliminated' : '';
    return `
      <label class="choice ${elimClass}" data-choice="${i}" for="${id}">
        <input id="${id}" type="radio" name="${q.id}" value="${i}" ${checked} />
        <div class="text"><b>${letter(i)}.</b> ${t}</div>
        <div class="letter">${letter(i)}</div>
      </label>
    `;
  }).join('');

  el.choices.querySelectorAll('.choice').forEach(choice=>{
    const idx = Number(choice.dataset.choice);
    const input = choice.querySelector('input');
    choice.addEventListener('click', (ev)=>{
      if (!state.eliminateMode) return;
      if (ev.target.tagName.toLowerCase()==='input') return;
      ev.preventDefault();
      toggleElimination(q.id, idx);
      choice.classList.toggle('eliminated');
      save();
    });
    input.addEventListener('change', ()=>{
      state.answers[q.id] = idx;
      save();
      renderProgress();
      buildPopGrid();
      buildCheckGrid();
    });
  });

  const flagged = !!state.flags[q.id];
  el.flagTop.classList.toggle('on', flagged);
  el.flagTop.setAttribute('aria-pressed', String(flagged));
  el.flagLabel.textContent = flagged ? 'For review' : 'Mark for review';

  el.elimToggle.classList.toggle('on', state.eliminateMode);
  el.elimToggle.setAttribute('aria-pressed', String(state.eliminateMode));
  el.elimHint.style.display = state.eliminateMode ? 'block' : 'none';
}

function toggleElimination(qid, idx){
  if (!state.elims[qid]) state.elims[qid] = new Set();
  const s = state.elims[qid];
  if (s.has(idx)) s.delete(idx); else s.add(idx);
}

function renderProgress(){
  const segs = el.progress.children.length;
  const active = Math.ceil(((state.index+1)/exam.questions.length)*segs);
  for(let i=0;i<segs;i++){
    el.progress.children[i].classList.toggle('active', i<active);
  }
  el.pillText.textContent = `Question ${state.index+1} of ${exam.questions.length}`;
}

function updatePillFlag(){
  const q = exam.questions[state.index];
  const flagged = !!state.flags[q.id];
  el.pillFlag.style.display = flagged ? 'block' : 'none';
}
function updateFlagVisuals(){
  const q = exam.questions[state.index];
  const flagged = !!state.flags[q.id];
  el.flagTop.classList.toggle('on', flagged);
  el.flagTop.setAttribute('aria-pressed', String(flagged));
  el.flagLabel.textContent = flagged ? 'For review' : 'Mark for review';
}

/* ---------- Review popover & page grids ---------- */
function buildPopGrid(){
  el.popGrid.innerHTML='';
  exam.questions.forEach((q,i)=>{
    const b=document.createElement('button');
    b.className='nbtn';
    b.textContent = String(i+1);
    const answered = typeof state.answers[q.id]==='number';
    const flagged  = !!state.flags[q.id];
    if (i===state.index){
      b.classList.add('current');
      const pin=document.createElement('span');
      pin.className='pin';
      pin.textContent='ðŸ“';
      b.appendChild(pin);
    }
    if (answered) b.classList.add('answered');
    if (flagged)  b.classList.add('review');
    b.addEventListener('click', ()=>{
      state.index=i;
      state.reviewMode=false;
      closePopover();
      render();
    });
    el.popGrid.appendChild(b);
  });
}
function buildCheckGrid(){
  el.checkGrid.innerHTML='';
  exam.questions.forEach((q,i)=>{
    const b=document.createElement('button');
    b.className='nbtn';
    b.textContent = String(i+1);
    const answered = typeof state.answers[q.id]==='number';
    const flagged  = !!state.flags[q.id];
    if (answered) b.classList.add('answered');
    if (flagged)  b.classList.add('review');
    b.addEventListener('click', ()=>{
      state.index=i;
      state.reviewMode=false;
      render();
      scrollTo(0,0);
    });
    el.checkGrid.appendChild(b);
  });
}

/* ===================== Actions ===================== */
function updateNavs(){
  const last = state.index===exam.questions.length-1 && !state.reviewMode;
  el.next.style.display = last ? 'none':'inline-block';
  el.finish.style.display = last ? 'inline-block':'none';
}
function go(delta){
  if (state.reviewMode){
    state.reviewMode=false;
    render();
    return;
  }
  const k = clamp(state.index + delta, 0, exam.questions.length-1);
  if (k===state.index) return;
  state.index = k;
  save();
  render();
}
function toggleFlag(){
  if (state.reviewMode) return;
  const q=exam.questions[state.index];
  state.flags[q.id]=!state.flags[q.id];
  save();
  updateFlagVisuals();
  updatePillFlag();
  buildPopGrid();
  buildCheckGrid();
}

/* Eliminate toggle */
el.elimToggle.addEventListener('click', ()=>{
  state.eliminateMode = !state.eliminateMode;
  el.elimToggle.classList.toggle('on', state.eliminateMode);
  el.elimToggle.setAttribute('aria-pressed', String(state.eliminateMode));
  el.elimHint.style.display = state.eliminateMode ? 'block' : 'none';
});

/* ===== Finish: save payload + write history to Firestore, then redirect ===== */
async function finishExam(){
  if(state.finished) return;
  state.finished=true;
  clearInterval(state.timerId);
  closePopover();

  // Build summary payload
  const items = exam.questions.map((q,i)=>{
    const chosen = (typeof state.answers[q.id] === 'number') ? state.answers[q.id] : null;
    return {
      number: i+1,
      id: q.id,
      prompt: q.prompt,
      choices: q.choices,
      correctIndex: q.answerIndex,
      chosenIndex: chosen,
      correct: chosen === q.answerIndex,
      explanation: q.explanation || ''
    };
  });

  const totals = {
    answered: items.filter(it => it.chosenIndex !== null).length,
    correct:  items.filter(it => it.correct).length,
    total:    items.length,
    timeSpentSec: exam.timeLimitSec - state.remaining
  };
  const scorePct = totals.total ? Math.round((totals.correct / totals.total) * 100) : 0;

  const summary = {
    title: exam.sectionTitle,
    generatedAt: new Date().toISOString(),
    totals,
    items
  };

  // Local summary for circles-summary.html
  try{
    localStorage.setItem(exam.summaryKey, JSON.stringify(summary));
  }catch(e){}

  // History/progress entry in Firestore (if user is logged in)
  try {
    const user = auth.currentUser;
    if (user) {
      await addDoc(collection(db, "practiceRuns"), {
        uid: user.uid,
        moduleId: "math-circles-v1",
        title: exam.sectionTitle,
        totals,
        scorePct,
        createdAt: serverTimestamp()
      });
    }
  } catch (e) {
    console.error("Failed to save practice run to Firestore:", e);
  }

  // Go to detailed summary page
  location.href = "circles-summary.html";
}

/* Popover */
const pill = document.getElementById('centerPill');
function openPopover(){ el.pop.style.display='block'; pill.setAttribute('aria-expanded','true'); }
function closePopover(){ el.pop.style.display='none'; pill.setAttribute('aria-expanded','false'); }
pill.addEventListener('click', ()=>{
  if (el.pop.style.display==='block') closePopover();
  else openPopover();
});
document.getElementById('popClose').addEventListener('click', closePopover);
el.goReview.addEventListener('click', ()=>{
  state.reviewMode=true;
  closePopover();
  render();
});

/* Close popover when clicking outside */
document.addEventListener('click', (e)=>{
  const inside = e.target===pill || pill.contains(e.target) || e.target===el.pop || el.pop.contains(e.target);
  if (!inside) closePopover();
});

/* Nav buttons */
document.getElementById('btnBack').addEventListener('click', ()=>go(-1));
document.getElementById('btnNext').addEventListener('click', ()=>go(1));
document.getElementById('btnFinish').addEventListener('click', finishExam);

/* ===================== Init ===================== */
(function init(){
  resetPractice();      // always start fresh
  render();
  startTimer();
})();
</script>
