<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Section 1, Module 1: Math — Circles (Practice)</title>
<style>
  :root{
    --bb-bg:#eef2fb;            /* page bg */
    --bb-rail:#e7edf9;          /* bottom rail */
    --bb-surface:#fff;
    --bb-ink:#111827;
    --bb-muted:#4b5563;
    --bb-line:#cfd7ea;
    --bb-strong:#aab6d6;
    --bb-blue:#1f4dd8;
    --bb-blue-dark:#1437a8;
    --bb-pill:#0b1227;
    --flag:#d11;                /* review flag red */
    --flag-soft:#fff0f0;
    --bb-green:#06d6a0;
    --radius:12px;
    --shadow:0 1px 2px rgba(16,24,40,.06), 0 6px 14px rgba(16,24,40,.08);
  }
  html,body{height:100%}
  body{
    margin:0;background:var(--bb-bg);color:var(--bb-ink);
    font:16px/1.5 Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  }
  .app{max-width:1280px;margin:0 auto;padding:12px 16px 120px}

  /* HEADER */
  .header{
    display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:16px;
    background:var(--bb-surface);border:1px solid var(--bb-line);
    border-radius:10px;padding:10px 14px;box-shadow:var(--shadow);position:sticky;top:8px;z-index:5;
  }
  .title{font-weight:700;font-size:18px}
  .directions{display:inline-flex;gap:6px;align-items:center;color:#111;background:transparent;border:0;font-weight:600}
  .timer{display:flex;flex-direction:column;align-items:center;justify-content:center}
  .timer b{font-size:26px;letter-spacing:.5px;font-variant-numeric:tabular-nums}
  .btn{border-radius:999px;border:1px solid var(--bb-line);background:#fff;padding:6px 12px;font-weight:600;cursor:pointer}
  .btn.primary{background:var(--bb-blue);border-color:var(--bb-blue);color:#fff}
  .btn.primary:hover{background:var(--bb-blue-dark);border-color:var(--bb-blue-dark)}
  .btn.ghost{background:#fff}
  .tools{justify-self:end;display:flex;gap:10px}

  /* PRACTICE banner + ticks */
  .ticks{
    margin:8px 2px 0; background:#0d1a5a; color:#fff; border-radius:10px; 
    height:22px; display:flex; align-items:center; justify-content:center;
    font-size:12px; font-weight:800; letter-spacing:.6px; box-shadow:var(--shadow);
  }
  .dashrow{display:grid;grid-template-columns:repeat(54,1fr);gap:3px;margin:6px 4px}
  .dash{height:5px;border-radius:2px;background:#000;opacity:.95}

  /* ----- ONE-COLUMN CENTERED QUESTION CARD ----- */
  .qwrap{
    margin-top:10px;display:flex;justify-content:center;
  }
  .qcard{
    width:min(980px, 96vw);
    background:#fff;border:1px solid var(--bb-line);border-radius:12px;box-shadow:var(--shadow);
    padding:16px;
  }

  /* Top row: number, dashed rule, actions */
  .qtop{
    display:grid;grid-template-columns:auto 1fr auto auto;align-items:center;gap:10px
  }
  .qbadge{
    width:34px;height:34px;background:#000;color:#fff;display:grid;place-items:center;border-radius:6px;font-weight:800
  }
  .qdash{
    border-bottom:4px dashed #111; height:0; margin:0 6px;
  }
  .flagbtn{
    display:inline-flex;align-items:center;gap:8px;border-radius:999px;border:1px solid var(--bb-line);
    background:#fff;color:#111;padding:6px 10px;font-weight:700;cursor:pointer
  }
  .flagbtn .flagicon{
    width:0;height:0;border-left:8px solid var(--flag);border-top:6px solid transparent;border-bottom:6px solid transparent;display:inline-block;opacity:.25
  }
  .flagbtn.on{border-color:var(--flag);background:var(--flag-soft)}
  .flagbtn.on .flagicon{opacity:1}
  .elimbtn{
    margin-left:8px;display:inline-flex;align-items:center;gap:8px;border-radius:8px;border:1px solid var(--bb-line);
    background:#fff;color:#111;padding:6px 10px;font-weight:700;cursor:pointer
  }
  .elimicon{
    width:20px;height:20px;border:2px solid #1f2a44;border-radius:50%;position:relative;display:inline-block
  }
  .elimicon::after{
    content:"";position:absolute;left:2px;right:2px;top:9px;height:2px;background:#1f2a44;transform:rotate(-20deg)
  }
  .elimbtn.on{border-color:#1f2a44;background:#f1f4ff}

  /* Question body */
  .qtitle{margin:14px 0 10px;font-size:20px;font-weight:800}
  .choices{display:grid;gap:12px;margin-top:8px}
  .choice{
    display:flex;align-items:center;gap:10px;border:1px solid var(--bb-line);border-radius:10px;background:#f7f8fd; padding:12px 14px; position:relative;
    transition:opacity .12s ease
  }
  .choice input{transform:scale(1.1)}
  .letter{
    margin-left:auto;width:32px;height:32px;border-radius:50%;border:2px solid #b7c1dd;display:grid;place-items:center;color:#1f2a44;font-weight:700;
  }
  /* Eliminated styling */
  .choice.eliminated{opacity:.4}
  .choice.eliminated .text{ text-decoration:line-through 2px }
  .choice.eliminated .letter{ position:relative }
  .choice.eliminated .letter::after{
    content:""; position:absolute; left:4px; right:4px; top:15px; height:2px; background:#1f2a44; transform:rotate(-20deg)
  }
  .hint{color:var(--bb-muted);font-size:14px;margin-top:4px}

  /* BOTTOM RAIL */
  .rail{
    position:fixed;left:0;right:0;bottom:0;background:var(--bb-rail);border-top:1px solid var(--bb-line);
    padding:12px 0; z-index:6;
  }
  .rail-inner{max-width:1280px;margin:0 auto;position:relative}
  .progress{display:grid;grid-template-columns:repeat(var(--seg,24),1fr);gap:8px;padding:0 16px}
  .seg{height:6px;border-radius:3px;background:#0b0b0b}
  .seg.active{background:#00a6e7}

  .center-pill{
    position:absolute;left:50%;transform:translateX(-50%);bottom:8px;background:var(--bb-pill);color:#fff;border-radius:999px;
    padding:8px 12px;font-weight:800;box-shadow:0 4px 12px rgba(0,0,0,.25);display:flex;align-items:center;gap:8px;cursor:pointer;border:0;
  }
  .center-pill .caret{font-weight:900}
  .pill-flag{display:none;width:0;height:0;border-left:10px solid var(--flag);border-top:7px solid transparent;border-bottom:7px solid transparent}

  .rail-actions{position:absolute;right:16px;bottom:4px;display:flex;gap:10px;align-items:center;}
  .rail-left{position:absolute;left:16px;bottom:4px;display:flex;gap:10px;align-items:center;}
  .btn.nav{min-width:78px}

  /* REVIEW POPOVER */
  .popover{
    position:fixed;left:50%;bottom:84px;transform:translateX(-50%);
    background:#fff;border:1px solid var(--bb-line);border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.18);
    width:min(620px,92vw);padding:14px;display:none;z-index:7;
  }
  .popover .title{font-weight:800;font-size:18px;margin:2px 0 8px}
  .popover .legend{display:flex;gap:18px;align-items:center;margin:10px 0;border-top:1px solid var(--bb-line);border-bottom:1px solid var(--bb-line);padding:8px 0;color:var(--bb-muted)}
  .legend .box{width:16px;height:16px;border:2px dashed #2b3350;border-radius:4px;background:#fff;display:inline-block;vertical-align:middle;margin-right:6px}
  .legend .flag{width:12px;height:12px;background:var(--flag);border-radius:2px;display:inline-block;margin-right:6px}
  .popover .grid{display:grid;grid-template-columns:repeat(10,1fr);gap:10px;margin-top:12px}
  .nbtn{
    display:inline-grid;place-items:center;height:36px;border:2px dashed #2b3350;border-radius:6px;background:#fff;
    color:#1f4dd8;font-weight:800;cursor:pointer;
  }
  .nbtn.current{box-shadow:0 0 0 2px #111 inset; position:relative}
  .pin{position:absolute;right:-6px;top:-8px;font-size:16px}
  .nbtn.answered{border-style:solid;border-color:#5b74d5}
  .nbtn.review{background:var(--flag-soft);border-color:var(--flag);border-style:solid}
  .nbtn .elimdot{width:8px;height:8px;border-radius:50%;background:#1f2a44;margin-left:6px}

  .popover .go-review{display:block;margin:14px auto 4px;background:#fff;border:2px solid #7da2ff;color:#1f4dd8;border-radius:24px;padding:8px 14px;font-weight:800;cursor:pointer}
  .popover .close{position:absolute;right:12px;top:8px;border:0;background:transparent;font-size:20px;cursor:pointer}

  /* REVIEW PAGE */
  .check-wrap{display:none;margin-top:18px}
  .check-head{font-size:28px;font-weight:800;text-align:center;margin:8px 0 6px}
  .check-sub{color:var(--bb-muted);text-align:center;margin-bottom:12px}
  .check-card{max-width:860px;margin:0 auto;background:#fff;border:1px solid var(--bb-line);border-radius:12px;box-shadow:var(--shadow);padding:14px}
  .check-row{display:flex;justify-content:space-between;align-items:center;color:#111;font-weight:700;margin-bottom:6px}
  .check-leg{display:flex;gap:18px;align-items:center;color:var(--bb-muted)}
  .grid-nums{display:grid;grid-template-columns:repeat(10,1fr);gap:10px;margin-top:12px}
  .grid-nums .nbtn{height:44px}

  /* RESULTS */
  .score{margin-top:10px;background:#fff;border:1px solid var(--bb-line);border-radius:10px;box-shadow:var(--shadow);padding:12px;display:none;}
  .muted{color:var(--bb-muted);font-size:14px}
</style>
</head>
<body>
  <div class="app">
    <!-- Header -->
    <div class="header" role="banner">
      <div>
        <div class="title" id="sectionTitle">Section 1, Module 1: Math — Circles (Practice)</div>
        <button class="directions" aria-label="Directions">Directions ▾</button>
      </div>
      <div class="timer" aria-live="polite">
        <b id="timeLeft">30:00</b>
        <button id="toggleTimer" class="btn ghost" aria-pressed="false">Hide</button>
      </div>
      <div class="tools">
        <button id="btnReview" class="btn ghost">Review</button>
        <button id="btnMore" class="btn ghost">More</button>
      </div>
    </div>

    <!-- Practice banner + ticks -->
    <div class="ticks">THIS IS A PRACTICE TEST</div>
    <div class="dashrow" id="dashrow"></div>

    <!-- ONE-COLUMN QUESTION CARD -->
    <div class="qwrap">
      <article class="qcard" id="qcard">
        <header class="qtop">
          <div class="qbadge" id="qbadge">1</div>
          <div class="qdash" aria-hidden="true"></div>
          <button id="flagTop" class="flagbtn" aria-pressed="false">
            <span class="flagicon"></span><span id="flagLabel">Mark for review</span>
          </button>
          <button id="elimToggle" class="elimbtn" aria-pressed="false" title="Eliminate answers">
            <span class="elimicon" aria-hidden="true"></span> Eliminate
          </button>
        </header>

        <h2 class="qtitle" id="qtitle">Question text</h2>
        <div class="choices" id="choices" role="radiogroup" aria-label="Choices"></div>
        <div class="hint" id="elimHint" style="display:none">Eliminate mode is on — click an answer to gray it out. Click again to restore.</div>
      </article>
    </div>

    <!-- Review page -->
    <section class="check-wrap" id="checkPage" aria-label="Check Your Work">
      <h1 class="check-head">Check Your Work</h1>
      <p class="check-sub">On test day, you won’t be able to move on to the next module until time expires.</p>
      <div class="check-card">
        <div class="check-row">
          <div>Section 1, Module 1: Reading and Writing Questions</div>
          <div class="check-leg">
            <span><span class="box" style="width:16px;height:16px;border:2px dashed #2b3350;border-radius:4px;display:inline-block;margin-right:6px"></span> Unanswered</span>
            <span><span class="flag" style="width:12px;height:12px;background:var(--flag);display:inline-block;margin-right:6px"></span> For Review</span>
          </div>
        </div>
        <div class="grid-nums" id="checkGrid"></div>
      </div>
    </section>

    <!-- Results -->
    <div class="score" id="score"></div>
  </div>

  <!-- Bottom rail -->
  <div class="rail" role="contentinfo">
    <div class="rail-inner">
      <div class="progress" id="progress"></div>
      <button class="center-pill" id="centerPill" aria-haspopup="dialog" aria-expanded="false">
        <div class="pill-flag" id="pillFlag"></div>
        <span id="pillText">Question 1 of 1</span><span class="caret">▾</span>
      </button>
      <div class="rail-left">
        <button id="btnBack" class="btn nav">Back</button>
      </div>
      <div class="rail-actions">
        <button id="btnNext" class="btn nav primary">Next</button>
        <button id="btnFinish" class="btn nav primary" style="display:none">End &amp; Score</button>
      </div>
    </div>
  </div>

  <!-- Review popover -->
  <div class="popover" id="popover" role="dialog" aria-modal="false" aria-label="Question Navigator">
    <button class="close" id="popClose" aria-label="Close">×</button>
    <div class="title">Section 1, Module 1: Reading and Writing Questions</div>
    <div class="legend">
      <span>📍 Current</span>
      <span><span class="box"></span> Unanswered</span>
      <span><span class="flag"></span> For Review</span>
    </div>
    <div class="grid" id="popGrid"></div>
    <button class="go-review" id="goReview">Go to Review Page</button>
  </div>

<script>
/* ===================== Exam Data ===================== */
const exam = {
  storageKey: 'dsa-circles-bluebook-v5',
  sectionTitle: 'Section 1, Module 1: Math — Circles (Practice)',
  timeLimitSec: 30 * 60,
  questions: [
    { id:'q1',
      prompt:'A circle has radius 5 cm. What is its circumference?',
      choices:['10π cm','25π cm','5π cm','50π cm'],
      answerIndex:0 },
    { id:'q2',
      prompt:'If a circle’s area is 49π, what is its radius?',
      choices:['3','7','14','24.5'],
      answerIndex:1 },
    { id:'q3',
      prompt:'A circle passes through (0,0) and (0,6) with center at (0,3). What is its equation?',
      choices:['(x − 0)² + (y − 3)² = 9','(x − 3)² + (y − 0)² = 9','(x − 3)² + (y − 3)² = 6','(x − 0)² + (y − 6)² = 3'],
      answerIndex:0 },
    { id:'q4',
      prompt:'For r = 10 and θ = π/3, what is the arc length s?',
      choices:['10π/3','20π/3','30π','10','π/3'],
      answerIndex:0 },
    { id:'q5',
      prompt:'Sector area for r = 6 and θ = π/2 is',
      choices:['9π','18π','36π','3π'],
      answerIndex:1 },
    { id:'q6',
      prompt:'If the diameter is 18, the area is',
      choices:['81π','36π','18π','9π'],
      answerIndex:0 }
  ]
};

/* ===================== State ===================== */
const state = {
  index: 0,
  answers: {},        // { qid: choiceIndex }
  flags: {},          // { qid: true }
  elims: {},          // { qid: Set([choiceIndex,...]) }
  eliminateMode: false,
  remaining: exam.timeLimitSec,
  timerId: null,
  timerHidden: false,
  finished: false,
  reviewMode: false
};

/* ===================== DOM ===================== */
const el = {
  sectionTitle: document.getElementById('sectionTitle'),
  timeLeft: document.getElementById('timeLeft'),
  toggleTimer: document.getElementById('toggleTimer'),
  qbadge: document.getElementById('qbadge'),
  qtitle: document.getElementById('qtitle'),
  choices: document.getElementById('choices'),
  flagTop: document.getElementById('flagTop'),
  flagLabel: document.getElementById('flagLabel'),
  elimToggle: document.getElementById('elimToggle'),
  elimHint: document.getElementById('elimHint'),

  back: document.getElementById('btnBack'),
  next: document.getElementById('btnNext'),
  finish: document.getElementById('btnFinish'),

  progress: document.getElementById('progress'),
  pill: document.getElementById('centerPill'),
  pillText: document.getElementById('pillText'),
  pillFlag: document.getElementById('pillFlag'),

  pop: document.getElementById('popover'),
  popGrid: document.getElementById('popGrid'),
  popClose: document.getElementById('popClose'),
  goReview: document.getElementById('goReview'),
  reviewBtn: document.getElementById('btnReview'),

  checkPage: document.getElementById('checkPage'),
  checkGrid: document.getElementById('checkGrid'),

  score: document.getElementById('score'),
  dashrow: document.getElementById('dashrow')
};

/* ===================== Static rows ===================== */
(function buildTicks(){
  for(let i=0;i<54;i++){ const d=document.createElement('div'); d.className='dash'; el.dashrow.appendChild(d); }
})();
(function buildProgress(){
  const seg = Math.max(24, exam.questions.length * 2);
  el.progress.style.setProperty('--seg', seg);
  el.progress.innerHTML='';
  for(let i=0;i<seg;i++){ const s=document.createElement('div'); s.className='seg'; el.progress.appendChild(s); }
})();

/* ===================== Storage ===================== */
function loadSaved(){
  try{
    const data = JSON.parse(localStorage.getItem(exam.storageKey)||'null');
    if(!data) return;
    Object.assign(state.answers, data.answers||{});
    Object.assign(state.flags, data.flags||{});
    // restore elims
    if (data.elims) {
      Object.keys(data.elims).forEach(q=>{
        state.elims[q] = new Set(data.elims[q]);
      });
    }
    if (typeof data.remaining==='number') state.remaining = data.remaining;
    if (typeof data.index==='number') state.index = clamp(data.index, 0, exam.questions.length-1);
  }catch(e){}
}
function save(){
  // persist Sets as arrays
  const elimsObj = {};
  Object.keys(state.elims).forEach(q=>{ elimsObj[q] = Array.from(state.elims[q]||[]); });
  localStorage.setItem(exam.storageKey, JSON.stringify({
    answers: state.answers, flags: state.flags, elims: elimsObj, remaining: state.remaining, index: state.index
  }));
}

/* ===================== Timer ===================== */
function startTimer(){ if(state.timerId || state.finished) return; tick(); state.timerId=setInterval(tick,1000); }
function tick(){
  if (state.remaining<=0) return finishExam();
  state.remaining--;
  const m=String(Math.floor(state.remaining/60)).padStart(2,'0');
  const s=String(state.remaining%60).padStart(2,'0');
  if(!state.timerHidden) el.timeLeft.textContent=`${m}:${s}`;
  save();
  if(state.remaining<=0) finishExam();
}
el.toggleTimer.addEventListener('click', ()=>{
  state.timerHidden=!state.timerHidden;
  el.toggleTimer.textContent = state.timerHidden ? 'Show' : 'Hide';
  el.timeLeft.style.visibility = state.timerHidden ? 'hidden' : 'visible';
});

/* ===================== Renderers ===================== */
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

function render(){
  el.sectionTitle.textContent = exam.sectionTitle;
  renderQuestion();
  renderProgress();
  buildPopGrid();
  buildCheckGrid();
  updateNavs(); updateFlagVisuals(); updatePillFlag();
  const m=String(Math.floor(state.remaining/60)).padStart(2,'0');
  const s=String(state.remaining%60).padStart(2,'0');
  el.timeLeft.textContent=`${m}:${s}`;
}

function renderQuestion(){
  const q = exam.questions[state.index];

  // top meta
  el.qbadge.textContent = state.index + 1;
  el.qtitle.textContent = q.prompt;

  // choices
  const letter = i => String.fromCharCode(65+i);
  const elimSet = state.elims[q.id] || new Set();
  el.choices.innerHTML = q.choices.map((t,i)=>{
    const id=`${q.id}_c${i}`;
    const checked = state.answers[q.id]===i ? 'checked':'';
    const elimClass = elimSet.has(i) ? 'eliminated' : '';
    return `
      <label class="choice ${elimClass}" data-choice="${i}" for="${id}">
        <input id="${id}" type="radio" name="${q.id}" value="${i}" ${checked} />
        <div class="text"><b>${letter(i)}.</b> ${t}</div>
        <div class="letter">${letter(i)}</div>
      </label>
    `;
  }).join('');

  // handlers
  el.choices.querySelectorAll('.choice').forEach(choice=>{
    const idx = Number(choice.dataset.choice);
    const input = choice.querySelector('input');
    // toggle elimination when in eliminate mode (click anywhere on the choice area except the radio circle)
    choice.addEventListener('click', (ev)=>{
      if (!state.eliminateMode) return; // normal
      if (ev.target.tagName.toLowerCase()==='input') return; // allow selecting via radio
      ev.preventDefault();
      toggleElimination(q.id, idx);
      choice.classList.toggle('eliminated');
      // persist
      save();
    });
    // normal selection
    input.addEventListener('change', ()=>{
      state.answers[q.id] = idx; save(); renderProgress(); buildPopGrid(); buildCheckGrid();
    });
  });

  // flag & eliminate controls
  const flagged = !!state.flags[q.id];
  el.flagTop.classList.toggle('on', flagged);
  el.flagTop.setAttribute('aria-pressed', String(flagged));
  el.flagLabel.textContent = flagged ? 'For review' : 'Mark for review';

  el.elimToggle.classList.toggle('on', state.eliminateMode);
  el.elimToggle.setAttribute('aria-pressed', String(state.eliminateMode));
  el.elimHint.style.display = state.eliminateMode ? 'block' : 'none';
}

function toggleElimination(qid, idx){
  if (!state.elims[qid]) state.elims[qid] = new Set();
  const s = state.elims[qid];
  if (s.has(idx)) s.delete(idx); else s.add(idx);
}

function renderProgress(){
  const segs = el.progress.children.length;
  const active = Math.ceil(((state.index+1)/exam.questions.length)*segs);
  for(let i=0;i<segs;i++){ el.progress.children[i].classList.toggle('active', i<active); }
  el.pillText.textContent = `Question ${state.index+1} of ${exam.questions.length}`;
}

function updatePillFlag(){
  const q = exam.questions[state.index];
  const flagged = !!state.flags[q.id];
  el.pillFlag.style.display = flagged ? 'block' : 'none';
}
function updateFlagVisuals(){
  const q = exam.questions[state.index];
  const flagged = !!state.flags[q.id];
  el.flagTop.classList.toggle('on', flagged);
  el.flagTop.setAttribute('aria-pressed', String(flagged));
  el.flagLabel.textContent = flagged ? 'For review' : 'Mark for review';
}

/* ---------- Review popover & page grids ---------- */
function buildPopGrid(){
  el.popGrid.innerHTML='';
  exam.questions.forEach((q,i)=>{
    const b=document.createElement('button');
    b.className='nbtn';
    b.textContent = String(i+1);
    const answered = typeof state.answers[q.id]==='number';
    const flagged  = !!state.flags[q.id];
    if (i===state.index){ b.classList.add('current'); const pin=document.createElement('span'); pin.className='pin'; pin.textContent='📍'; b.appendChild(pin); }
    if (answered) b.classList.add('answered');
    if (flagged)  b.classList.add('review');
    b.addEventListener('click', ()=>{
      state.index=i; state.reviewMode=false; closePopover(); render();
    });
    el.popGrid.appendChild(b);
  });
}
function buildCheckGrid(){
  el.checkGrid.innerHTML='';
  exam.questions.forEach((q,i)=>{
    const b=document.createElement('button');
    b.className='nbtn';
    b.textContent = String(i+1);
    const answered = typeof state.answers[q.id]==='number';
    const flagged  = !!state.flags[q.id];
    if (answered) b.classList.add('answered');
    if (flagged)  b.classList.add('review');
    b.addEventListener('click', ()=>{ state.index=i; state.reviewMode=false; render(); scrollTo(0,0); });
    el.checkGrid.appendChild(b);
  });
}

/* ===================== Actions ===================== */
function updateNavs(){
  const last = state.index===exam.questions.length-1 && !state.reviewMode;
  el.next.style.display = last ? 'none':'inline-block';
  el.finish.style.display = last ? 'inline-block':'none';
}
function go(delta){
  if (state.reviewMode){ state.reviewMode=false; render(); return; }
  const k = clamp(state.index + delta, 0, exam.questions.length-1);
  if (k===state.index) return;
  state.index = k; save(); render();
}
function toggleFlag(){
  if (state.reviewMode){ return; }
  const q=exam.questions[state.index];
  state.flags[q.id]=!state.flags[q.id]; save();
  updateFlagVisuals(); updatePillFlag(); buildPopGrid(); buildCheckGrid();
}

/* Eliminate toggle */
el.elimToggle.addEventListener('click', ()=>{
  state.eliminateMode = !state.eliminateMode;
  el.elimToggle.classList.toggle('on', state.eliminateMode);
  el.elimToggle.setAttribute('aria-pressed', String(state.eliminateMode));
  el.elimHint.style.display = state.eliminateMode ? 'block' : 'none';
});

/* Flag button at top */
el.flagTop.addEventListener('click', toggleFlag);

function finishExam(){
  if(state.finished) return;
  state.finished=true; clearInterval(state.timerId);
  closePopover();

  // grade
  let correct=0, answered=0;
  const rows = exam.questions.map((q,i)=>{
    const chosen = state.answers[q.id];
    const done = typeof chosen==='number';
    const ok = done && chosen===q.answerIndex;
    if(done) answered++; if(ok) correct++;
    const status = ok ? '✅ Correct' : (done?'❌ Incorrect':'⚠️ Unanswered');
    const detail = done ? `You chose “${q.choices[chosen]}”.` : '';
    return `<div style="padding:10px;border:1px solid var(--bb-line);border-radius:10px;margin-bottom:8px">
      <b>Q${i+1}</b> — ${status}<div class="muted">Correct answer: “${q.choices[q.answerIndex]}”. ${detail}</div>
    </div>`;
  }).join('');

  const pct = Math.round(100*correct/exam.questions.length);
  el.score.innerHTML = `
    <h2 style="margin:0 0 8px">Results</h2>
    <div class="muted">Answered: <b>${answered}/${exam.questions.length}</b> • Correct: <b>${correct}</b> • Score: <b>${pct}%</b></div>
    <div style="margin-top:10px">${rows}</div>
  `;
  document.getElementById('qcard').style.display='none';
  el.checkPage.style.display='none';
  el.score.style.display='block';
}

/* ---------- Popover controls ---------- */
function openPopover(){ el.pop.style.display='block'; el.pill.setAttribute('aria-expanded','true'); }
function closePopover(){ el.pop.style.display='none'; el.pill.setAttribute('aria-expanded','false'); }

/* ===================== Wire up ===================== */
document.getElementById('btnMore').addEventListener('click', ()=>alert('More menu placeholder'));
el.back.addEventListener('click', ()=>go(-1));
el.next.addEventListener('click', ()=>go(1));
el.finish.addEventListener('click', finishExam);

el.pill.addEventListener('click', ()=>{ if (el.pop.style.display==='block') closePopover(); else openPopover(); });
el.popClose.addEventListener('click', closePopover);
el.goReview.addEventListener('click', ()=>{ state.reviewMode=true; closePopover(); render(); });
el.reviewBtn.addEventListener('click', ()=>{ state.reviewMode = !state.reviewMode; render(); });

/* Close popover when clicking outside */
document.addEventListener('click', (e)=>{
  const inside = e.target===el.pill || el.pill.contains(e.target) || e.target===el.pop || el.pop.contains(e.target);
  if (!inside) closePopover();
});

/* ===================== Init ===================== */
(function init(){
  loadSaved();
  render();
  startTimer();
})();
</script>
</body>
</html>
