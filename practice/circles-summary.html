<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Circles — Summary</title>
<style>
  :root{
    --bg:#eef2fb;--surface:#fff;--ink:#0f172a;--muted:#64748b;--line:#d9e0f2;
    --good:#11a36a;--bad:#d33;--pill:#0b1227;--blue:#1f4dd8;--shadow:0 6px 14px rgba(16,24,40,.08);
  }
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;}
  .wrap{max-width:1100px;margin:0 auto;padding:20px 16px 80px}
  .card{background:var(--surface);border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow);padding:16px}
  h1{margin:.25rem 0 .35rem}
  .muted{color:var(--muted)}
  .top{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px}
  .score{
    background:#0b1227;color:#fff;border-radius:999px;padding:8px 12px;font-weight:800;display:inline-flex;gap:10px
  }
  .actions{display:flex;gap:10px;flex-wrap:wrap}
  .btn{border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 12px;font-weight:700;cursor:pointer;text-decoration:none;color:inherit}
  .btn.primary{background:var(--blue);border-color:var(--blue);color:#fff}

  /* grid of Qs */
  .qs{margin-top:14px;display:grid;gap:12px}
  .q{border:1px solid var(--line);border-radius:12px;padding:14px;background:#fff}
  .qhead{display:flex;align-items:center;gap:10px;margin-bottom:8px}
  .badge{width:32px;height:32px;border-radius:6px;display:grid;place-items:center;font-weight:900;color:#fff}
  .badge.ok{background:var(--good)} .badge.no{background:var(--bad)}
  .prompt{font-weight:800}
  .choices{margin-top:6px;display:grid;gap:6px}
  .choice{border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:#f7f8fd;display:flex;justify-content:space-between;align-items:center}
  .tag{font-size:12px;border-radius:999px;padding:3px 8px}
  .tag.ok{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0}
  .tag.you{background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe}
  .tag.correct{background:#f0fdf4;color:#166534;border:1px solid #bbf7d0}
  .tag.wrong{background:#fff1f2;color:#991b1b;border:1px solid #fecdd3}
  .exp{margin-top:8px;color:var(--muted)}
  .empty{max-width:760px;margin:40px auto;text-align:center}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="headerCard">
      <div class="top">
        <div>
          <h1 id="title">Summary</h1>
          <div class="muted" id="meta"></div>
        </div>
        <div class="score" id="scorePill"></div>
      </div>
      <div class="actions">
        <a class="btn" href="circles.html">← Back to practice</a>
        <button class="btn primary" id="retake">Retake this set</button>
        <button class="btn" id="clear">Clear my answers</button>
      </div>
    </div>

    <div class="qs" id="qs"></div>

    <div class="card empty" id="empty" style="display:none">
      <h2>No summary found</h2>
      <p class="muted">Take the practice first, then you’ll land here automatically with a full breakdown.</p>
      <a class="btn primary" href="circles.html">Start Practice</a>
    </div>
  </div>

<script>
(function(){
  // Primary key your practice page writes to:
  const SUMMARY_KEY = 'dsa-circles-summary-v1';
  // Graceful fallback (older builds):
  const FALLBACK_KEY = 'dsa-last-summary';

  // Read whichever exists
  const raw = localStorage.getItem(SUMMARY_KEY) || localStorage.getItem(FALLBACK_KEY);
  const data = raw ? JSON.parse(raw) : null;

  const qsEl   = document.getElementById('qs');
  const title  = document.getElementById('title');
  const meta   = document.getElementById('meta');
  const pill   = document.getElementById('scorePill');
  const empty  = document.getElementById('empty');
  const header = document.getElementById('headerCard');

  if (!data || !data.items || !Array.isArray(data.items) || data.items.length === 0) {
    // Nothing to show (this should not happen after the fix, but keep a graceful fallback)
    empty.style.display = 'block';
    header.style.display = 'none';
    return;
  }

  // Normalize fields from the structure saved by circles.html
  // circles.html stores: { title, generatedAt, totals:{answered,correct,total,timeSpentSec}, items:[{chosenIndex, correctIndex, ...}] }
  const totals     = data.totals || {};
  const answered   = typeof totals.answered === 'number' ? totals.answered : 0;
  const correct    = typeof totals.correct === 'number'  ? totals.correct  : 0;
  const total      = typeof totals.total === 'number'    ? totals.total    : data.items.length;
  const scorePct   = total ? Math.round((correct/total)*100) : 0;
  const finishedAt = data.generatedAt || new Date().toISOString();

  title.textContent = data.title || 'Summary';
  meta.textContent  = `Answered ${answered}/${total} • Correct ${correct} • Completed ${new Date(finishedAt).toLocaleString()}`;
  pill.textContent  = `Score: ${scorePct}%`;

  const letter = i => String.fromCharCode(65+i);

  data.items.forEach(it=>{
    const userIndex = (typeof it.chosenIndex === 'number') ? it.chosenIndex : null;
    const ok = (userIndex !== null) && (userIndex === it.correctIndex);

    const sec = document.createElement('section');
    sec.className = 'q';
    sec.innerHTML = `
      <div class="qhead">
        <div class="badge ${ok ? 'ok' : 'no'}">${it.number ?? ''}</div>
        <div class="prompt">${it.prompt || ''}</div>
      </div>
      <div class="choices">
        ${ (it.choices || []).map((c,i)=>{
            const isCorrect = i === it.correctIndex;
            const isUser    = i === userIndex;
            const tags = [
              isUser ? '<span class="tag you">Your choice</span>' : '',
              isCorrect ? '<span class="tag correct">Correct</span>' : ''
            ].join(' ');
            return `<div class="choice">
                      <div><b>${letter(i)}.</b> ${c}</div>
                      <div style="display:flex;gap:6px">${tags}</div>
                    </div>`;
          }).join('') }
      </div>
      <div class="exp"><b>Explanation:</b> ${it.explanation || '—'}</div>
    `;
    qsEl.appendChild(sec);
  });

  // Buttons
  document.getElementById('retake').addEventListener('click', ()=>{
    // Clear the practice progress so the user starts fresh
    try {
      const PRACTICE_KEY = 'dsa-circles-bluebook-v7'; // <-- matches circles.html
      const rawPractice = localStorage.getItem(PRACTICE_KEY);
      if (rawPractice){
        const obj = JSON.parse(rawPractice);
        obj.answers = {};
        obj.flags   = {};
        obj.elims   = {};
        localStorage.setItem(PRACTICE_KEY, JSON.stringify(obj));
      }
    } catch(e){}
    location.href = 'circles.html';
  });

  document.getElementById('clear').addEventListener('click', ()=>{
    localStorage.removeItem(SUMMARY_KEY);
    localStorage.removeItem(FALLBACK_KEY);
    alert('Summary cleared.');
  });
})();
</script>
</body>
</html>
